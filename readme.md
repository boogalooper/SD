## SD Helper - cкрипт (jsx), предназначенный для обработки выделенного фрагмента изображения в Stable Diffusion.

Работает во всех версиях Adobe Photoshop серии Creative Cloud (начиная с CC 2014 (15 версии)) для Windows. Поддерживаются интерфейсы AUTOMATIC1111 и WebUI Forge. Скрипт поддерживает русскую и английскую локализацию (устанавливается автоматически, в зависимости от языка интерфейса Фотошопа).

* [Установка](#Установка)
* [Работа со скриптом](#Работа-со-скриптом)
* [Интерфейс](#Интерфейс)
* [Модуль SD Face restore](#Модуль-SD-Face-restore)
* [Работа по сети](#Работа-по-сети)

## Установка

#### Установка Stable Diffusion:

1. Установите [**AUTOMATIC1111**](https://github.com/AUTOMATIC1111) или [**stable-diffusion-webui-forge**](https://github.com/lllyasviel/stable-diffusion-webui-forge). Возможна установка портативных версий или специальных сборок Stable Diffusion из других источников, главное чтобы была возможность включить доступ по API.
2. Скачайте и поместите в папку `models\Stable-diffusion\` любой чекпоинт с которым вы привыкли работать. Для ретуши портретов я использую [**Realistic Vision v5.1**](https://huggingface.co/SG161222/Realistic_Vision_V5.1_noVAE) (учтите, что для некоторых версий может понадобиться установка [VAE](https://huggingface.co/stabilityai/sd-vae-ft-mse-original))
3. Включите доступ по API для установленной Stable Diffusion, добавив ключ `--api` параметры запуска `COMMANDLINE_ARGS` файла `webui-user.bat`
4. Установите [**python**](https://www.python.org/) актуальной верии, в процессе установки активируйте опцию `добавить в PATH`

#### Установка файлов скрипта в Photoshop:

1. Скачайте файлы [SD Helper.jsx](SD%20Helper.jsx) и [sd-webui-api v2.pyw](sd-webui-api%20v2.pyw), скопируйте их в папку Фотошопа `Presets\Scripts\`
2. Если Фотошоп запущен, перезапустите его. Скрипт появится в меню `File->Sripts`

## Работа со скриптом

> ### Перед началом работы со скриптом запустите локально установленную версию Stable Diffusion и дождитесь её полной загрузки

### Особенности запуска скрипта

Скрипт имеет 2 режима запуска:

1. `Режим диалогового окна`. В нем можно настроить или скорректировать основные параметры генерации
2. `Тихий режим`. Скрипт не показывает окно настроек, а сразу выполняет генерацию с ранее сохраненными параметрами.

Режим диалогового окна активируется при первом запуске скрипта (после каждого перезапуска Фотошопа), а также после возникновения ошибки в процессе генерации. Все последующие запуски осуществляются в тихом режиме. Для запуска скрипта в режиме диалогого окна в любой момент времени, можно:

* запустить скрипт из меню фотошопа `File->Sripts->SD Hepler` удерживая при этом нажатой клавишу shift
* записать скрипт в экшен и активировать значок запуска с диалоговым окном
  ![](assets/160057.png)
* использовать файл сценария [SD API forwarding.vbs](SD%20API%20forwarding.vbs) чтобы запустить скрипт из интерфейса операционной системы (ручной запуск, запуск с помощью хоткеев и т.п.). Этот вспомогательный файл запускает сценарий Windows передающий Фотошопу команду на запуск скрипта. Диалоговый режим активируется в том, если файлу `SD API forwarding.vbs`передан `любой` ненулевой аргумент командной строки.

### Режим img2img

Создайте выделение любым удобным инструментом (если вы создали выделение в быстрой маске, можно не выходить из неё - скрипт сделает это автоматически):
![](assets/154035.png)
Запустите скрипт, настройте параметры генерации, сгенерируйте изображение. Оно будет автоматически вставлено на новый слой.

### Режим inpaint

В этом режиме необходимо разделить область генерации и изображение которое будет передано в Stable Diffusion, для этого: переключитесь в режим быстрой маски, выделите кистью зону в которой будет происходить генерация. Не выходя из быстрой маски создайте выделение, ограничивающую область которая будет передана в качестве генерации.

![](assets/154704.png)
Запустите скрипт, настройте параметры генерации (не забудьте указать один из доступных режимов `Inpainting fill mode`, сгенерируйте изображение. Оно будет автоматически вставлено на новый слой.

## Интерфейс

Окно скрипта содержит основные параметры Stable Diffusion, необходимые для генерации изображений в режиме img2img.

![](assets/135628.png)

* `Stable Diffusion checkpoint` - список доступных чекпоинтов, предварительно обученных моделей искусственного интеллекта для генерации изображений
* `SD VAE` - список доступных VAE, энкодеров предназначенных для улучшения качестве генерируемых изображений. При использовании облегченных моделей GGUF список позволяет сделать выбор нескольких энкодеров в соответствии с рекомендациями их авторов.
* `Inpainting fill mode` - переключатель режима inpaint. Если в списке выбрано `none`, то скрипт работает в режиме img2img (генерация изображения, похожего на выделенный фрагмент), если выбран любой из доступных способов заливки, то скрипт работает в режиме inpaint (генерация отдельных деталей внутри существующего изображения)
* `Prompt` - позитивный промпт, текстовая подсказка которой следует нейросеть в процессе генерации. По-умолчанию поле не заполнено. Можно сохранять промпты в виде пресетов, также есть модуль перевода введенного промпта
* `Negative prompt` - негативный промпт, текстовая подсказка, указывающая нейросети чего нужно избегать в процессе генерации. По-умолчанию добавлено два пресета: SD и Realistic рассчитанных на уменьшение деформаций в процессе ретуши. Можно сохранять промпты в виде пресетов, также есть модуль перевода введенного промпта
* `Sampling method` - список доступных сэмплеров, методов преобразования случайного шума в готовое изображение. Напрямую влияет на качество, стиль и скорость генерации.
* `Scheldue type` - список доступных планировщиков, алгоритмов управляющих уровнем шума в процессе генерации
* `Sampling steps` - количество шагов, которые нейросеть делает, пока генерирует изображение
* 'CFG Scale' - регулирование баланса между безусловной и условной генерацией. Чем выше CFG Scale, тем больше нейросеть будет следовать введенным промптам
* 'Resize' - регулировка размера изображения передаваемого неросети. Может быть ручной и автоматической (рассчитывается в соответствии с правилами указанными в настройках скрипта)
* Denoising strength - сила шумоподавления. Определяет, насколько сильно нейросеть будет изменять исходное изображение или в процессе генерации. Влияет на баланс между
  сохранением исходных деталей и созданием новых элементов.

Если у вас установлено несколько чекпоинтов, то скрипт запоминает настройки генерации для каждого.

### Настройки скрипта

![](assets/141016.png)

* `Show items` - скрипт позволяет включить или отключить видимость отдельных параметров генерации (при этом их настройки запоминаются, скрытие элемента управления предназначено только для упрощения работы с интерфейсом и не означает что скрытый параметр больше не влияет на генерацию)
* `Image settings`
  * * `Flatten layers before generation` - опция определяет склеивать слои перед отправкой выделенного фрагмента изображения на генерацию или нет (при отключенной опции скрипт работает только с содержимым выделенного слоя, игнорируя видимую композицию слоев в документе. При включенной опции документ будет предварительно склеен и на генерацию отправится композитное изображение всех видимых слоев)
  * * `Rasterize generated image` - после окончания генерации скрипт помещает полученный фрагмент на новый слой. Опция определяет будет ли этот слой растеризован или вставлен как смарт-объект
* `Brush settings`- после вставки сгенерированного изображения на новый слой скрипт автоматически создает для него маску слоя. `Select brush after processing` определяет нужно ли автоматически активировать инструмент `brush` после создания маски, а `brush opacity` указывает какую непрозрачность кисти нужно установить
* `Auto resize` - при включении `Set scale value based on selection size`позволяет автоматически подбирать масштаб генерируемого изображения в зависимости от размеров активного выделения
* `Do not record generation settings to action` - опция позволяющая записывать скрипт в экшены в режиме 'bypass'. При отключенной опции в экшен записываются все текущие настройки скрипта, что позволяет хранить их отдельно от основных настроек и использовать при генерации. При включенной опции экшен просто запускает скрипт, его настройки не хранятся в палитре экшенов, вместо этого используются текущие

### Файл настроек

текущие настройки скрипта хранятся в каталоге настроек Фотошопа `%appdata%\Roaming\Adobe\Adobe Photoshop\Adobe Photoshop Settings\SD Helper.desc`

## Модуль SD Face restore

Модуль [SD Face restore.jsx](SD%20Face%20restore.jsx) предназначен для запуска алгоритмов улучшения лиц GFPGAN и CodeFormer. Принцип работы и запуска скрипта аналогичен `SD Helper`

![](assets/162930.png)

Для запуска в режиме диалогового окна можно использовать файл сценария [SD face restore.vbs](SD%20face%20restore.vbs)

## Работа по сети

`SD Hepler` и `SD Face restore` поддерживают работу по сети. Для доступа к Stable Diffusion запущенном на удаленном компьютере необходимо открыть код соответсвующего скрипта и указать адрес сетевого устройства на котором запущена Stable Diffusion в константе `SD_HOST`. При необходимости можно указать порт в константе `SD_PORT`. Управление очередью задач осуществляется встроенным планировщиком Stable Diffusion.

